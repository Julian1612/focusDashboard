<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dein Fokus-Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-color: #f5f5f7;
            --card-bg-color: #ffffff;
            --text-color: #1d1d1f;
            --text-secondary-color: #6e6e73;
            --accent-color: #007aff;
            --cancel-color: #ff3b30;
            --border-color: #d2d2d7;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --card-border-radius: 18px;
            --progress-bar-bg: #eef5ff;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 40px 20px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .top-widgets {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .todo-widgets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--card-border-radius);
            box-shadow: 0 4px 12px var(--shadow-color);
            padding: 15px 25px;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collapsible h2 {
            cursor: pointer;
        }
        
        .collapsible .toggle-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary-color);
        }

        .collapsible .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px; /* arbitrary large value */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, opacity 0.3s ease-in-out;
            margin-top: 10px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            margin-top: 0 !important;
            opacity: 0;
        }


        .todo-section h2 {
            font-size: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .add-todo-form { display: flex; gap: 10px; margin-bottom: 20px; }

        .add-todo-form input {
            background-color: #f0f0f0;
            border: 1px solid #f0f0f0;
            color: var(--text-color);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .add-todo-form input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }
        .add-todo-form input[type="text"] { flex-grow: 1; }
        .add-todo-form input[type="number"] { width: 80px; text-align: center; }

        .add-todo-form button {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 20px;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .add-todo-form button:hover { background-color: #0056b3; }
        
        .todo-list { list-style: none; padding: 0; margin: 0; min-height: 50px; }

        .todo-item {
            display: flex; align-items: center; padding: 15px 5px;
            border-bottom: 1px solid #e8e8ed;
            transition: opacity 0.3s ease, background-color 0.2s;
            cursor: grab;
        }
        .todo-item:active { cursor: grabbing; }
        .todo-item:last-child { border-bottom: none; }
        .todo-item.dragging { opacity: 0.5; background-color: #eef5ff; }
        .todo-item .task-content { flex-grow: 1; }
        .todo-item .task-time {
            background-color: #e8e8ed; color: var(--text-secondary-color);
            font-size: 0.8rem; font-weight: 500; padding: 4px 8px;
            border-radius: 6px; margin-right: 10px;
        }
        .todo-item.completed { opacity: 0.5; }
        .todo-item.completed .task-content { text-decoration: line-through; }
        
        .start-timer-btn, .pause-todo-btn {
            background: none; border: 1px solid var(--border-color);
            color: var(--accent-color); border-radius: 50%; width: 30px;
            height: 30px; font-size: 1rem; cursor: pointer;
            transition: all 0.2s ease; display: flex;
            justify-content: center; align-items: center;
        }
        .start-timer-btn:hover, .pause-todo-btn:hover { background-color: #e8e8ed; }
        .start-timer-btn:disabled, .pause-todo-btn:disabled { cursor: not-allowed; opacity: 0.4; }
        .pause-todo-btn { display: none; }

        .routine-card .routine-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary-color);
        }
        .routine-card .routine-item input[type="checkbox"] {
            margin-right: 10px;
            accent-color: var(--accent-color);
        }
        .routine-card .routine-item label.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .routine-card strong { color: var(--text-color); font-weight: 600; font-size: 0.9rem; display: block; margin-bottom: 8px; }
        .routine-card .routine-section { margin-bottom: 12px; }
        .routine-card .routine-section:last-child { margin-bottom: 0; }
        
        .timer-card { text-align: center; }
        #timer-display {
            font-size: 3rem; font-weight: 600; margin: 0;
            color: var(--text-color); transition: color 0.3s ease;
            font-variant-numeric: tabular-nums;
        }
        #timer-display.active { color: var(--accent-color); }
        
        .mini-timer {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary-color);
            margin-left: auto;
            padding-left: 15px;
            display: none;
            font-variant-numeric: tabular-nums;
        }
        .timer-card.collapsed-view .mini-timer {
            display: inline;
        }

        #timer-controls { display: flex; justify-content: center; gap: 10px; margin-top: 5px; height: 30px; }
        .timer-control-btn {
            background-color: var(--card-bg-color); border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 0.9rem; padding: 0 12px;
            cursor: pointer; transition: all 0.2s ease; display: none;
        }
        .timer-control-btn:hover { background-color: #e8e8ed; }
        #pause-resume-btn { color: var(--accent-color); }
        #cancel-btn { color: var(--cancel-color); }

        .day-controls { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .day-control-btn {
            background: none; border: 1px solid var(--border-color);
            color: var(--text-secondary-color); font-size: 0.8rem;
            padding: 5px 10px; border-radius: 8px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .day-control-btn:hover { background-color: #e8e8ed; color: var(--text-color); }
        
        .goal-section { margin-top: 10px; }
        .progress-bar-container {
            width: 100%; background-color: var(--progress-bar-bg);
            border-radius: 8px; height: 16px; overflow: hidden; margin-top: 10px;
        }
        #progress-bar {
            width: 0%; height: 100%; background-color: var(--accent-color);
            border-radius: 8px; transition: width 0.5s ease-out;
        }
        #goal-progress-text {
            font-size: 0.8rem; color: var(--text-secondary-color); margin-top: 8px;
        }

        .music-card iframe {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            border: none;
        }

        @media (max-width: 1100px) {
            .top-widgets {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .todo-widgets {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="top-widgets">
            <div class="card music-card collapsible">
                <h2 id="music-toggle">
                    <span>Fokus FM</span>
                    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </h2>
                <div id="music-content" class="collapsible-content">
                    <iframe src="https://www.youtube.com/embed/-z77ikRecGI" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
            <div class="card routine-card collapsible">
                <h2 id="routine-toggle">
                    <span>Meine Routine</span>
                    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </h2>
                <div id="routine-content" class="collapsible-content">
                    <div class="routine-section">
                        <strong>Morgen-Routine: Klarheit & Fokus</strong>
                        <div class="routine-item"><input type="checkbox" id="r1"><label for="r1">Tages-Check: Kalender, E-Mails und To-Do's</label></div>
                        <div class="routine-item"><input type="checkbox" id="r2"><label for="r2">Ankn√ºpfen: Erkenntnisse/Notizen von gestern pr√ºfen</label></div>
                        <div class="routine-item"><input type="checkbox" id="r3"><label for="r3">Aufgaben planen: Hinter jede Aufgabe die Zeit eintragen</label></div>
                        <div class="routine-item"><input type="checkbox" id="r4"><label for="r4">Eat the Frog: Mit der wichtigsten Aufgabe starten</label></div>
                    </div>
                     <div class="routine-section">
                        <strong>Arbeitsbl√∂cke: Maximale Effizienz</strong>
                        <div class="routine-item"><input type="checkbox" id="r5"><label for="r5">Fokus-Soundtrack an</label></div>
                    </div>
                    <div class="routine-section">
                        <strong>Feierabend-Routine: Abschalten & Vorbereiten</strong>
                        <div class="routine-item"><input type="checkbox" id="r9"><label for="r9">Brain-Dump f√ºr Morgen: Offene Punkte festhalten</label></div>
                        <div class="routine-item"><input type="checkbox" id="r10"><label for="r10">Clear-Desk: Arbeitsplatz aufr√§umen</label></div>
                    </div>
                </div>
            </div>
            <div class="card timer-card collapsible">
                <h2 id="timer-toggle">
                    <span>Fokussitzung</span>
                    <span id="mini-timer-display" class="mini-timer">00:00</span>
                    <svg class="toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </h2>
                <div id="timer-content" class="collapsible-content">
                    <div id="timer-display">00:00</div>
                    <div id="timer-controls">
                        <button id="pause-resume-btn" class="timer-control-btn">‚è∏ Pausieren</button>
                        <button id="cancel-btn" class="timer-control-btn">‚èπ Abbrechen</button>
                    </div>
                    <div class="goal-section">
                        <div class="progress-bar-container">
                            <div id="progress-bar"></div>
                        </div>
                        <div id="goal-progress-text">0 Min / 0 Std erreicht</div>
                    </div>
                    <div class="day-controls">
                        <button id="new-day-btn" class="day-control-btn">Neuer Tag ‚ú®</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="todo-widgets">
            <div class="card todo-section">
                <h2>Vormittag</h2>
                <form class="add-todo-form" id="form-vormittag">
                    <input type="text" id="input-task-vormittag" placeholder="Neue Aufgabe..." required>
                    <input type="number" id="input-time-vormittag" placeholder="Min" min="1" step="1" required>
                    <button type="submit">+</button>
                </form>
                <ul class="todo-list" id="list-vormittag"></ul>
            </div>
            <div class="card todo-section">
                <h2>Nachmittag</h2>
                <form class="add-todo-form" id="form-nachmittag">
                    <input type="text" id="input-task-nachmittag" placeholder="Neue Aufgabe..." required>
                    <input type="number" id="input-time-nachmittag" placeholder="Min" min="1" step="1" required>
                    <button type="submit">+</button>
                </form>
                <ul class="todo-list" id="list-nachmittag"></ul>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const timerDisplay = document.getElementById('timer-display');
            const miniTimerDisplay = document.getElementById('mini-timer-display');
            const pauseResumeBtn = document.getElementById('pause-resume-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const newDayBtn = document.getElementById('new-day-btn');
            const progressBar = document.getElementById('progress-bar');
            const goalProgressText = document.getElementById('goal-progress-text');
            
            const collapsibles = {
                music: {
                    toggle: document.getElementById('music-toggle'),
                    content: document.getElementById('music-content'),
                    icon: document.getElementById('music-toggle').querySelector('.toggle-icon'),
                    card: document.querySelector('.music-card')
                },
                routine: {
                    toggle: document.getElementById('routine-toggle'),
                    content: document.getElementById('routine-content'),
                    icon: document.getElementById('routine-toggle').querySelector('.toggle-icon'),
                    card: document.querySelector('.routine-card')
                },
                timer: {
                    toggle: document.getElementById('timer-toggle'),
                    content: document.getElementById('timer-content'),
                    icon: document.getElementById('timer-toggle').querySelector('.toggle-icon'),
                    card: document.querySelector('.timer-card')
                }
            };
            
            const routineCheckboxes = document.querySelectorAll('.routine-card input[type="checkbox"]');
            const lists = {
                vormittag: { form: document.getElementById('form-vormittag'), taskInput: document.getElementById('input-task-vormittag'), timeInput: document.getElementById('input-time-vormittag'), listEl: document.getElementById('list-vormittag') },
                nachmittag: { form: document.getElementById('form-nachmittag'), taskInput: document.getElementById('input-task-nachmittag'), timeInput: document.getElementById('input-time-nachmittag'), listEl: document.getElementById('list-nachmittag') }
            };

            // --- STATE VARIABLES ---
            let countdown, totalTimeWorked = 0, audioCtx, isPaused = false, secondsLeft = 0, endTime, activeTaskItem = null, originalMinutes = 0;

            // --- GOAL & PROGRESS LOGIC ---
            function calculateTotalTaskTime() {
                let totalMinutes = 0;
                document.querySelectorAll('.todo-item .task-time').forEach(timeEl => {
                    totalMinutes += parseInt(timeEl.textContent, 10) || 0;
                });
                return totalMinutes;
            }

            function updateGoalDisplay() {
                const dailyGoalInMinutes = calculateTotalTaskTime();
                const dailyGoalInHours = (dailyGoalInMinutes / 60).toFixed(1);
                const percentage = dailyGoalInMinutes > 0 ? Math.min((totalTimeWorked / dailyGoalInMinutes) * 100, 100) : 0;
                progressBar.style.width = `${percentage}%`;
                let goalText = `${totalTimeWorked} Min / ${dailyGoalInHours} Std erreicht`;
                if (percentage >= 100 && dailyGoalInMinutes > 0) {
                    goalText += " - Ziel erreicht! üéâ";
                }
                goalProgressText.textContent = goalText;
            }

            // --- SOUND LOGIC ---
            function playSound(type) {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                
                if (type === 'complete') {
                    o.type = 'sine';
                    o.frequency.setValueAtTime(1200, audioCtx.currentTime);
                    g.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
                } else { // notification
                    o.type = 'sine';
                    o.frequency.setValueAtTime(880, audioCtx.currentTime);
                    g.gain.setValueAtTime(0.5, audioCtx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 1);
                }
                
                o.start(audioCtx.currentTime);
                o.stop(audioCtx.currentTime + (type === 'complete' ? 0.3 : 1));
            }

            // --- TIMER LOGIC ---
            function timer(seconds) {
                clearInterval(countdown);
                endTime = Date.now() + seconds * 1000;
                displayTimeLeft(seconds);
                countdown = setInterval(() => {
                    secondsLeft = Math.round((endTime - Date.now()) / 1000);
                    if (secondsLeft < 0) {
                        clearInterval(countdown); playSound('notification'); updateTotalTime(originalMinutes);
                        activeTaskItem.querySelector('input[type="checkbox"]').checked = true;
                        activeTaskItem.classList.add('completed');
                        saveAllTodos(); resetTimerState(); return;
                    }
                    displayTimeLeft(secondsLeft);
                }, 1000);
            }

            function displayTimeLeft(seconds) {
                const m = Math.floor(seconds / 60), s = seconds % 60;
                const display = `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                timerDisplay.textContent = display; 
                miniTimerDisplay.textContent = display;
                document.title = `${display} - Fokus!`;
            }

            function togglePause() {
                isPaused = !isPaused;
                const pauseText = isPaused ? '‚ñ∂ Fortsetzen' : '‚è∏ Pausieren';
                pauseResumeBtn.innerHTML = pauseText;
                if(activeTaskItem) {
                    activeTaskItem.querySelector('.pause-todo-btn').innerHTML = isPaused ? '‚ñ∂' : '‚è∏';
                }

                if (isPaused) {
                    clearInterval(countdown);
                } else {
                    timer(secondsLeft);
                }
            }

            function startTimer(minutes, taskItem) {
                if (countdown) return;
                originalMinutes = minutes; secondsLeft = minutes * 60; activeTaskItem = taskItem; isPaused = false;
                timerDisplay.classList.add('active');
                document.querySelectorAll('.start-timer-btn').forEach(btn => btn.disabled = true);
                
                activeTaskItem.querySelector('.start-timer-btn').style.display = 'none';
                activeTaskItem.querySelector('.pause-todo-btn').style.display = 'flex';

                pauseResumeBtn.innerHTML = '‚è∏ Pausieren'; 
                pauseResumeBtn.style.display = 'inline-block'; 
                cancelBtn.style.display = 'inline-block';
                timer(secondsLeft);
            }

            function cancelTimer() { clearInterval(countdown); resetTimerState(); }

            function resetTimerState() {
                if(activeTaskItem) {
                    activeTaskItem.querySelector('.start-timer-btn').style.display = 'flex';
                    activeTaskItem.querySelector('.pause-todo-btn').style.display = 'none';
                }
                countdown = null; activeTaskItem = null; originalMinutes = 0; isPaused = false;
                displayTimeLeft(0);
                timerDisplay.classList.remove('active');
                document.title = 'Dein Fokus-Dashboard';
                document.querySelectorAll('.start-timer-btn').forEach(btn => btn.disabled = false);
                pauseResumeBtn.style.display = 'none'; cancelBtn.style.display = 'none';
            }

            function updateTotalTime(minutes) {
                totalTimeWorked += minutes;
                localStorage.setItem('totalTimeWorked', totalTimeWorked);
                updateGoalDisplay();
            }

            // --- DATA & TODO LIST LOGIC ---
            function loadData() {
                totalTimeWorked = parseInt(localStorage.getItem('totalTimeWorked') || '0', 10);
                
                for (const key in lists) {
                    const storedTodos = JSON.parse(localStorage.getItem(key)) || [];
                    storedTodos.forEach(todo => addTodoItem(todo, lists[key].listEl));
                }
                updateGoalDisplay();
                loadRoutineState();
                
                Object.keys(collapsibles).forEach(key => {
                    const isCollapsed = localStorage.getItem(`${key}Collapsed`) === 'true';
                    collapsibles[key].content.classList.toggle('collapsed', isCollapsed);
                    collapsibles[key].icon.classList.toggle('collapsed', isCollapsed);
                    if (key === 'timer') {
                        collapsibles[key].card.classList.toggle('collapsed-view', isCollapsed);
                    }
                });
            }

            function saveAllTodos() {
                for (const key in lists) {
                    const todos = [];
                    lists[key].listEl.querySelectorAll('.todo-item').forEach(item => {
                        todos.push({
                            text: item.querySelector('.task-content').textContent,
                            time: parseInt(item.querySelector('.task-time').textContent, 10),
                            completed: item.classList.contains('completed')
                        });
                    });
                    localStorage.setItem(key, JSON.stringify(todos));
                }
            }
            
            function loadRoutineState() {
                const routineState = JSON.parse(localStorage.getItem('routineState')) || {};
                routineCheckboxes.forEach(checkbox => {
                    checkbox.checked = routineState[checkbox.id] || false;
                    const label = checkbox.nextElementSibling;
                    if (label) {
                        label.classList.toggle('completed', checkbox.checked);
                    }
                });
            }
            
            function saveRoutineState() {
                const routineState = {};
                routineCheckboxes.forEach(checkbox => {
                    routineState[checkbox.id] = checkbox.checked;
                });
                localStorage.setItem('routineState', JSON.stringify(routineState));
            }

            function addTodoItem(todo, listEl) {
                const item = document.createElement('li');
                item.classList.add('todo-item');
                if (todo.completed) item.classList.add('completed');
                item.draggable = true;
                item.innerHTML = `
                    <input type="checkbox" ${todo.completed ? 'checked' : ''}>
                    <span class="task-content">${todo.text}</span>
                    <span class="task-time">${todo.time} min</span>
                    <button class="start-timer-btn" title="Fokus-Sitzung starten">‚ñ∂</button>
                    <button class="pause-todo-btn" title="Pause/Fortsetzen">‚è∏</button>
                `;
                listEl.appendChild(item);
                item.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                    item.classList.toggle('completed');
                    if(e.target.checked) {
                        playSound('complete');
                    }
                    saveAllTodos();
                });
                item.querySelector('.start-timer-btn').addEventListener('click', () => startTimer(todo.time, item));
                item.querySelector('.pause-todo-btn').addEventListener('click', () => togglePause());
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => item.classList.remove('dragging'));
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.todo-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                    else return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // --- EVENT LISTENERS ---
            for (const key in lists) {
                const current = lists[key];
                current.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const taskText = current.taskInput.value.trim();
                    const taskTime = parseInt(current.timeInput.value, 10);
                    if (taskText === '' || isNaN(taskTime) || taskTime <= 0) return;
                    addTodoItem({ text: taskText, time: taskTime, completed: false }, current.listEl);
                    saveAllTodos(); 
                    updateGoalDisplay();
                    current.form.reset(); 
                    current.taskInput.focus();
                });
                current.listEl.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(current.listEl, e.clientY);
                    const dragging = document.querySelector('.dragging');
                    if (afterElement == null) current.listEl.appendChild(dragging);
                    else current.listEl.insertBefore(dragging, afterElement);
                });
                current.listEl.addEventListener('drop', e => { 
                    e.preventDefault(); 
                    saveAllTodos();
                    updateGoalDisplay();
                });
            }
            
            pauseResumeBtn.addEventListener('click', togglePause);
            cancelBtn.addEventListener('click', cancelTimer);
            
            routineCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const label = e.target.nextElementSibling;
                    if (label) {
                        label.classList.toggle('completed', e.target.checked);
                    }
                    saveRoutineState();
                });
            });
            
            Object.keys(collapsibles).forEach(key => {
                collapsibles[key].toggle.addEventListener('click', () => {
                    const isCollapsed = collapsibles[key].content.classList.toggle('collapsed');
                    collapsibles[key].icon.classList.toggle('collapsed', isCollapsed);
                    if (key === 'timer') {
                        collapsibles[key].card.classList.toggle('collapsed-view', isCollapsed);
                    }
                    localStorage.setItem(`${key}Collapsed`, isCollapsed);
                });
            });

            function resetForNewDay() {
                if (confirm('Neuer Tag? Alle To-Dos und der Zeitz√§hler werden zur√ºckgesetzt.')) {
                    cancelTimer();
                    for (const key in lists) {
                        lists[key].listEl.innerHTML = '';
                        localStorage.removeItem(key);
                    }
                    totalTimeWorked = 0; 
                    localStorage.setItem('totalTimeWorked', '0');
                    updateGoalDisplay();
                    
                    localStorage.removeItem('routineState');
                    loadRoutineState();
                }
            }

            newDayBtn.addEventListener('click', resetForNewDay);

            // --- INITIALIZATION ---
            loadData();
        });
    </script>
</body>
</html>
